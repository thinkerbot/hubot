#!/bin/bash

body=$(cat - | sed -e 's/\([\"]\)/\\\1/g')

if [ "$body" != "" ]
then
  subdomain=${HUBOT_CAMPFIRE_SUBDOMAIN:-}
  room=${HUBOT_CAMPFIRE_ROOM:-}

  # Get the campfire token
  token=$(
    curl -s -b cookies.txt -c cookies.txt "https://$subdomain.campfirenow.com/member/edit" | 
    grep 'id="token"' | 
    sed -e 's/.*">\([^<]\{1,\}\)<.*/\1/'
  )

  # Post the message
  curl -s -u "$token:X" -H 'Content-Type: application/json' -d "{\"message\":{\"body\":\"$body\"}}" "https://$subdomain.campfirenow.com/room/$room/speak.json" > /dev/null
fi
