#!/bin/bash

subdomain=${HUBOT_CAMPFIRE_SUBDOMAIN:-}
room=${HUBOT_CAMPFIRE_ROOM:-}
cookies=${HUBOT_COOKIES_FILE:-var/hubot/cookies}

############################################################################
# Setup stream to inbox
############################################################################

# Enter the room
curl -s -b "$cookies" -c "$cookies" "https://$subdomain.campfirenow.com/room/$room" > /dev/null

# Get the campfire token
token=$(
  curl -s -b cookies.txt -c cookies.txt "https://$subdomain.campfirenow.com/member/edit" | 
  grep 'id="token"' | 
  sed -e 's/.*">\([^<]\{1,\}\)<.*/\1/'
)

# Replace CR with LF so the output will be line delimited. Then use sed to
# extract the body such that it will properly expand when read as a line and
# used like "$line" (requires 'read -r')
curl -sN --max-time 31536000 -u "$token:X" https://streaming.campfirenow.com/room/$HUBOT_CAMPFIRE_ROOM/live.json | 
tr -u "\r" "\n" | 
sed -le 's/.*"body":"\(.\{1,\}\)","id":.*/\1/' | 
sed -le 's/\\\("\)/"/g'
