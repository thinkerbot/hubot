#!/bin/bash

HUBOT_BIN_DIR="$( cd "$( dirname $0 )" && pwd)"

if [ -z "$HUBOT_PLUGINS_DIR" ]
then
  export HUBOT_PLUGINS_DIR=$HUBOT_BIN_DIR/plugins
fi

if [ -z "$HUBOT_ADAPTERS_DIR" ]
then
  HUBOT_ADAPTERS_DIR=$HUBOT_BIN_DIR/adapters
fi


usage() {
cat <<EOF
usage: $0 options

OPTIONS:
  -h   Show this message
  -l   List adapters
  -p   List plugins
  -a   Adapter to use (default: shell)

EOF
}

HUBOT_PLUGINS=""
HUBOT_ADAPTERS=""
HUBOT_ADAPTER="$HUBOT_ADAPTERS_DIR/shell"
HUBOT_TTY=false

if [ -t 0 ]
then HUBOT_TTY=true
fi
export HUBOT_TTY

# This is the only Hubot function available to the adapters
# It is up to the adapters how to execute the plugins
# (i.e. in serial or parallel) and what do do with the output.
list_plugins() {
    HUBOT_PLUGINS=`find $HUBOT_PLUGINS_DIR -maxdepth 1 -type f -perm -o+x`
}

export -f list_plugins
#export $PLUGINS

list_adapters() {
    HUBOT_ADAPTERS=`find $HUBOT_ADAPTERS_DIR/* -maxdepth 1 -type d`
}


_print_paths() {
    # Pretty-print adapter & plugin paths for the command line
    for p in $@
    do
        echo "  `basename $p`"
    done
}

while getopts "hlpa:" OPTION
do
  case $OPTION in
      h)
          usage
          exit 0
          ;;
      l)
          list_adapters
          echo "Available adapters"
          _print_paths $HUBOT_ADAPTERS
          exit 0
          ;;
      p)
          list_plugins
          echo "Available plugins"
          _print_paths $HUBOT_PLUGINS
          exit 0
          ;;
      a)
          HUBOT_ADAPTER="$HUBOT_ADAPTERS_DIR/$OPTARG"
          ;;
      ?)
          usage
          exit 0
          ;;
  esac
done

LISTEN="$HUBOT_ADAPTER/listen"
SAY="$HUBOT_ADAPTER/say"

if [ ! -e "$LISTEN" ]
then
    echo "Adapter listen command not found: $LISTEN"
    exit 1
fi

if [ ! -e "$SAY" ]
then
    echo "Adapter say command not found: $SAY"
    exit 1
fi

if [ ! -x "$LISTEN" ]
then
    echo "Adapter listen command is not executable: $LISTEN"
    exit 1
fi

if [ ! -x "$SAY" ]
then
    echo "Adapter say command is not executable: $SAY"
    exit 1
fi

$LISTEN | 
while read -r input
do
    list_plugins
    for plugin in $HUBOT_PLUGINS
    do
        printf "$input\n" | $plugin | 
        while read -r output
        do printf "$output\n" | $SAY
        done
    done
done
